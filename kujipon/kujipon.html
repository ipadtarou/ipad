<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>くじゲーム（統合版）</title>
  <style>
    /* 共通スタイル */
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background-color: #f0f0f0;
      font-family: sans-serif;
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      border: none;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
    }
    #screen-start {
      margin: 0;
      padding: 0;
      border: none;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
      background-color: #fff;
    }
    .screen {
      display: none;
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      overflow: auto;
      background: inherit;
    }
    .active {
      display: block;
    }
    /* index画面 */
    #screen-index #container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #screen-index img {
      max-width: 80%;
      height: auto;
    }
    #screen-index #btns {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .clickable {
      cursor: pointer;
    }
    /* settei画面 */
    #screen-settei {
      text-align: center;
      padding: 20px;
      background-color: #f9f9f9;
    }
    #screen-settei .section {
      margin: 20px 0;
    }
    #screen-settei button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid #ccc;
      background-color: white;
      cursor: pointer;
    }
    #screen-settei button:hover {
      background-color: #eee;
    }
    #screen-settei .selected {
      border: 3px solid red !important;
      font-weight: bold;
    }
    /* start画面 */
    #screen-start {
      background-color: #fff;
    }
    #kuji-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 15px;
      padding: 0;
      margin: 20px 0;
      width: 100vw;
      height: calc(100vh - 40px);
      box-sizing: border-box;
      overflow: hidden;
    }
    .kuji {
      position: relative;
      border: 4px solid red;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.1s ease-in-out;
    }
    .kuji.pushed {
      transform: scale(1.1);
    }
    .kuji.clicked {
      pointer-events: none;
    }
    .kuji img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: hue-rotate(0deg);
    }
    .suka-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: black;
      font-weight: bold;
      z-index: 20;
      pointer-events: none;
      text-shadow: 0 0 5px white, 0 0 5px white, 0 0 5px white;
    }
    .kuji img.overlay {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .message-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 5em;
      color: red;
      font-weight: bold;
      z-index: 100;
      display: none;
    }
    .back-button {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      z-index: 101;
    }
  </style>
</head>
<body>
  <!-- index画面 -->
  <div id="screen-index" class="screen active">
    <div id="container">
      <img src="kuji.png" alt="くじ" draggable="false">
      <div id="btns">
        <img src="start.png" alt="スタート" class="clickable" draggable="false" onclick="showScreen('settei')">
        <img src="settei.png" alt="設定" class="clickable" style="margin-top: 20px;" draggable="false" onclick="showScreen('settei')">
      </div>
    </div>
  </div>
  <!-- 設定画面 -->
  <div id="screen-settei" class="screen">
    <div class="section">
      <h2>くじの数を選んでください</h2>
      <div id="kujiButtons"></div>
    </div>
    <div class="section" id="atariSection"></div>
    <div class="section" id="hazureSection"></div>
    <div class="section" id="atariSound">
      <h2>あたり音を選んでください</h2>
      <div id="atariButtons"></div>
    </div>
    <div class="section" id="hazureSound">
      <h2>はずれ音を選んでください</h2>
      <div id="hazureButtons"></div>
    </div>
    <div class="section">
      <h2>ゲームモード</h2>
      <label>
        <input type="checkbox" id="loseModeCheckbox">
        はずれを引いたら負け
      </label>
      <br>
      <label>
        <input type="checkbox" id="winModeCheckbox">
        あたりを全部引いたら勝ち
      </label>
    </div>
    <div class="section">
      <button onclick="saveAndStart()">設定を保存してスタート</button>
      <br>
      <button style="margin-top: 10px;" onclick="showScreen('index')">戻る</button>
    </div>
  </div>
  <!-- ゲーム画面 -->
  <div id="screen-start" class="screen">
    <div id="kuji-container"></div>
    <div id="messageOverlay" class="message-overlay"></div>
    <button class="back-button" onclick="showScreen('index')">戻る</button>
  </div>
  <script>
    // 画面切り替え
    function showScreen(name) {
      document.querySelectorAll('.screen').forEach(div => div.classList.remove('active'));
      document.getElementById('screen-' + name).classList.add('active');
      if (name === 'settei') initSettei();
      if (name === 'start') initGame();
    }
    // index画面の無効化処理
    document.addEventListener("DOMContentLoaded", () => {
      document.addEventListener("contextmenu", e => e.preventDefault());
      document.addEventListener("gesturestart", e => e.preventDefault());
      document.addEventListener("gesturechange", e => e.preventDefault());
      document.addEventListener("gestureend", e => e.preventDefault());
      initSettei();
    });
    // 設定画面のロジック
    let kujiCount = 0;
    let atariCount = 0;
    let hazureCount = 0;
    let selectedAtariSound = 'random';
    let selectedHazureSound = 'random';
    function clearSelection(parentId) {
      const buttons = document.getElementById(parentId).querySelectorAll('button');
      buttons.forEach(btn => btn.classList.remove('selected'));
    }
    function selectKuji(n) {
      kujiCount = n;
      atariCount = 0;
      hazureCount = 0;
      clearSelection('kujiButtons');
      document.getElementById(`kujiBtn${n}`).classList.add('selected');
      document.getElementById('atariSection').innerHTML = '<p>あたりの数を選んでください</p>';
      for (let i = 0; i <= n; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.onclick = () => {
          clearSelection('atariSection');
          btn.classList.add('selected');
          selectAtari(i);
        };
        document.getElementById('atariSection').appendChild(btn);
      }
      document.getElementById('hazureSection').innerHTML = '';
    }
    function selectAtari(n) {
      atariCount = n;
      const hazureMax = kujiCount - atariCount;
      document.getElementById('hazureSection').innerHTML = '<p>はずれの数を選んでください</p>';
      for (let i = 0; i <= hazureMax; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.onclick = () => {
          clearSelection('hazureSection');
          btn.classList.add('selected');
          hazureCount = i;
        };
        document.getElementById('hazureSection').appendChild(btn);
      }
    }
    function playSound(name, index) {
      const audio = new Audio(`${name}${index}.mp3`);
      audio.play();
    }
    function selectSound(parentId, name, index, isAtari) {
      clearSelection(parentId);
      document.getElementById(`${name}${index}`).classList.add('selected');
      if (isAtari) {
        selectedAtariSound = `${name}${index}`;
      } else {
        selectedHazureSound = `${name}${index}`;
      }
      playSound(name, index);
    }
    function selectRandomSound(isAtari, button) {
      clearSelection(button.parentElement.id);
      button.classList.add('selected');
      if (isAtari) {
        selectedAtariSound = 'random';
        const r = Math.floor(Math.random() * 5) + 1;
        playSound('正解', r);
      } else {
        selectedHazureSound = 'random';
        const sounds = ['ブー1', 'ブー2', 'ブー3', 'ブー4', 'ブー5', '爆発1', '爆発2', '爆発3', '爆発4'];
        const s = sounds[Math.floor(Math.random() * sounds.length)];
        new Audio(`${s}.mp3`).play();
      }
    }
    function saveAndStart() {
      if (kujiCount === 0) {
        alert('くじの数を選んでください。');
        return;
      }
      const config = {
        kujiCount: kujiCount,
        atariCount: atariCount,
        hazureCount: hazureCount,
        seikaiSound: selectedAtariSound,
        hazureSound: selectedHazureSound,
        loseMode: document.getElementById('loseModeCheckbox').checked,
        winMode: document.getElementById('winModeCheckbox').checked
      };
      localStorage.setItem('kujiConfig', JSON.stringify(config));
      showScreen('start');
    }
    function initSettei() {
      // くじボタン生成
      const kujiButtons = document.getElementById('kujiButtons');
      if (kujiButtons.childElementCount === 0) {
        for (let i = 1; i <= 20; i++) {
          const btn = document.createElement('button');
          btn.id = `kujiBtn${i}`;
          btn.innerText = i;
          btn.onclick = () => selectKuji(i);
          kujiButtons.appendChild(btn);
        }
      }
      // あたり・はずれ音ボタン生成
      const atariButtons = document.getElementById('atariButtons');
      if (atariButtons.childElementCount === 0) {
        for (let i = 1; i <= 5; i++) {
          const btn = document.createElement('button');
          btn.id = `正解${i}`;
          btn.innerText = `正解${i}`;
          btn.onclick = () => selectSound('atariButtons', '正解', i, true);
          atariButtons.appendChild(btn);
        }
        const randBtn = document.createElement('button');
        randBtn.innerText = 'ランダム';
        randBtn.className = 'selected';
        randBtn.onclick = function() { selectRandomSound(true, this); };
        atariButtons.appendChild(randBtn);
      }
      const hazureButtons = document.getElementById('hazureButtons');
      if (hazureButtons.childElementCount === 0) {
        for (let i = 1; i <= 5; i++) {
          const btn = document.createElement('button');
          btn.id = `ブー${i}`;
          btn.innerText = `ブー${i}`;
          btn.onclick = () => selectSound('hazureButtons', 'ブー', i, false);
          hazureButtons.appendChild(btn);
        }
        for (let i = 1; i <= 4; i++) {
          const btn = document.createElement('button');
          btn.id = `爆発${i}`;
          btn.innerText = `爆発${i}`;
          btn.onclick = () => selectSound('hazureButtons', '爆発', i, false);
          hazureButtons.appendChild(btn);
        }
        const randBtn = document.createElement('button');
        randBtn.innerText = 'ランダム';
        randBtn.className = 'selected';
        randBtn.onclick = function() { selectRandomSound(false, this); };
        hazureButtons.appendChild(randBtn);
      }
    }
    // ゲーム画面のロジック
    function initGame() {
      const params = JSON.parse(localStorage.getItem('kujiConfig')) || {
        kujiCount: 10,
        atariCount: 3,
        hazureCount: 2,
        seikaiSound: 'random',
        hazureSound: 'random',
        loseMode: false,
        winMode: false
      };
      const total = parseInt(params.kujiCount);
      const ataris = Array(parseInt(params.atariCount)).fill('atari');
      const hazures = Array(parseInt(params.hazureCount)).fill('hazure');
      const sukas = Array(total - ataris.length - hazures.length).fill('suka');
      let pool = [...ataris, ...hazures, ...sukas];
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      const hueStep = 360 / total;
      let openedAtariCount = 0;
      let gameEnded = false;
      const kujiContainer = document.getElementById('kuji-container');
      kujiContainer.innerHTML = '';
      for (let i = 0; i < total; i++) {
        const kuji = document.createElement('div');
        kuji.className = 'kuji';
        const img = document.createElement('img');
        img.src = '1.png';
        const hue = i * hueStep;
        img.style.filter = `hue-rotate(${hue}deg)`;
        img.dataset.hue = hue;
        kuji.appendChild(img);
        kuji.onclick = (e) => {
          if (e.button !== 0 || kuji.classList.contains('clicked') || gameEnded) return;
          kuji.classList.add('pushed');
          setTimeout(() => kuji.classList.remove('pushed'), 150);
          const baseImg = kuji.querySelector('img:first-child');
          baseImg.style.filter = `hue-rotate(${baseImg.dataset.hue}deg) grayscale(1)`;
          kuji.classList.add('clicked');
          const type = pool[i];
          if (type === 'atari') {
            openedAtariCount++;
            const overlay = document.createElement('img');
            overlay.src = 'seikai.gif';
            overlay.className = 'overlay';
            kuji.appendChild(overlay);
            playSeikai();
            if (params.winMode && openedAtariCount === parseInt(params.atariCount)) {
              showEndMessage('YOU WIN', 'lime');
            }
          } else if (type === 'hazure') {
            const overlay = document.createElement('img');
            overlay.src = 'hazure.gif';
            overlay.className = 'overlay';
            kuji.appendChild(overlay);
            playHazure();
            if (params.loseMode) {
              showEndMessage('YOU LOSE', 'red');
            }
          } else {
            const sukaText = document.createElement('div');
            sukaText.className = 'suka-text';
            sukaText.innerText = 'すか';
            const kujiSize = kuji.offsetWidth;
            sukaText.style.fontSize = `${kujiSize * 0.5}px`;
            kuji.appendChild(sukaText);
            playSuka();
          }
        };
        kujiContainer.appendChild(kuji);
      }
      function adjustLayout() {
        const kujiElements = document.querySelectorAll('.kuji');
        if (kujiElements.length === 0) return;
        const total = kujiElements.length;
        const gap = 15;
        const verticalMargin = 40; // 上下20pxずつ
        const kujiContainer = document.getElementById('kuji-container');
        kujiContainer.style.width = `${window.innerWidth}px`;
        kujiContainer.style.height = `${window.innerHeight - verticalMargin}px`;
        kujiContainer.style.overflow = 'hidden';
        // 画像サイズの最大値をウィンドウサイズの90%に制限
        const maxWidth = window.innerWidth * 0.9;
        const maxHeight = (window.innerHeight - verticalMargin) * 0.9;
        let bestSize = 0;
        let bestCols = 0;
        for (let cols = 1; cols <= total; cols++) {
          const rows = Math.ceil(total / cols);
          const sizeBasedOnWidth = (window.innerWidth - (cols - 1) * gap) / cols;
          const sizeBasedOnHeight = (window.innerHeight - verticalMargin - (rows - 1) * gap) / rows;
          let currentSize = Math.floor(Math.min(sizeBasedOnWidth, sizeBasedOnHeight));
          // 最大値制限
          currentSize = Math.min(currentSize, maxWidth / cols, maxHeight / rows);
          if (currentSize > bestSize) {
            bestSize = currentSize;
            bestCols = cols;
          }
        }
        if (bestSize > 0) {
          kujiElements.forEach(kuji => {
            kuji.style.width = `${bestSize}px`;
            kuji.style.height = `${bestSize}px`;
          });
          document.querySelectorAll('.suka-text').forEach(text => {
            text.style.fontSize = `${bestSize * 0.5}px`;
          });
        }
      }
      adjustLayout();
      window.addEventListener('resize', adjustLayout);
      function showEndMessage(message, color) {
        const overlay = document.getElementById('messageOverlay');
        overlay.innerText = message;
        overlay.style.color = color;
        overlay.style.display = 'flex';
        gameEnded = true;
      }
      function playSeikai() {
        if (params.seikaiSound === 'random') {
          const r = Math.floor(Math.random() * 5) + 1;
          new Audio(`正解${r}.mp3`).play();
        } else {
          new Audio(`${params.seikaiSound}.mp3`).play();
        }
      }
      function playHazure() {
        if (params.hazureSound === 'random') {
          const sounds = ['ブー1', 'ブー2', 'ブー3', 'ブー4', 'ブー5', '爆発1', '爆発2', '爆発3', '爆発4'];
          const s = sounds[Math.floor(Math.random() * sounds.length)];
          new Audio(`${s}.mp3`).play();
        } else {
          new Audio(`${params.hazureSound}.mp3`).play();
        }
      }
      function playSuka() {
        new Audio('suka.mp3').play();
      }
    }
  </script>
</body>
</html>
